# This GitHub action runs your tests for each commit push and/or PR. Optionally
# you can turn it on using a cron schedule for regular testing.
#
name: Tests
on:
  pull_request:
    paths-ignore:
      - "README.md"
  push:
    branches:
      - master
    paths-ignore:
      - "README.md"
  # For systems with an upstream API that could drift unexpectedly (like most SaaS systems, etc.),
  # we recommend testing at a regular interval not necessarily tied to code changes. This will
  # ensure you are alerted to something breaking due to an API change, even if the code did not
  # change.
  # schedule:
  #   - cron: '0 13 * * *'
jobs:
  # ensure the code builds...
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.3"
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v4

      - name: Get dependencies
        run: |
          go mod download

      - name: Build Provider
        run: |
          go build -v .

      - name: Build CLI
        run: |
          go build -v -o jsonschema-validator ./cmd/jsonschema-validator

      - name: Test CLI
        run: |
          ./jsonschema-validator --version
          ./jsonschema-validator --help

          # Test successful validation
          ./jsonschema-validator -s examples/pre-commit/schema.json examples/pre-commit/valid.json

          # Test validation failure (should exit with code 1)
          if ./jsonschema-validator -s examples/pre-commit/schema.json examples/pre-commit/invalid.json 2>&1; then
            echo "ERROR: Expected validation to fail but it passed"
            exit 1
          else
            echo "✓ Validation correctly failed for invalid.json"
          fi

  # run acceptance tests in a matrix with Terraform core versions
  test:
    name: Matrix Test
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        # list whatever Terraform versions here you would like to support
        terraform:
          - "1.0.5"
          - "1.11.4"
          - "1.12.2"
          - "1.13.5"
    steps:
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.3"
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v4

      - name: Get dependencies
        run: |
          go mod download

      - name: TF acceptance tests
        timeout-minutes: 10
        env:
          TF_ACC: "1"
          TF_ACC_TERRAFORM_VERSION: ${{ matrix.terraform }}

          # Set whatever additional acceptance test env vars here. You can
          # optionally use data from your repository secrets using the
          # following syntax:
          # SOME_VAR: ${{ secrets.SOME_VAR }}

        run: |
          go test -v -coverprofile=coverage.txt -covermode=atomic ./internal/provider/

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # run example tests to ensure all examples work correctly
  examples:
    name: Test Examples
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.3"
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v4

      - name: Get dependencies
        run: |
          go mod download

      - name: Build provider for examples
        run: |
          go build -o terraform-provider-jsonschema .
          OS=$(go env GOOS)
          ARCH=$(go env GOARCH)
          mkdir -p ~/.terraform.d/plugins/registry.terraform.io/binlab/jsonschema/0.0.0-dev/${OS}_${ARCH}/
          mv terraform-provider-jsonschema ~/.terraform.d/plugins/registry.terraform.io/binlab/jsonschema/0.0.0-dev/${OS}_${ARCH}/

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.5"

      - name: Test all examples
        run: |
          set +e  # Don't exit on error
          failed=0

          # Find all directories containing main.tf files
          for example_dir in examples/*/; do 
            if [ -f "${example_dir}main.tf" ]; then
              echo "=== Testing ${example_dir} ==="
              
              cd "$example_dir"
              
              # Create terraform.rc to use local provider
              cat > ~/.terraformrc << EOF
          provider_installation {
            filesystem_mirror {
              path    = "$HOME/.terraform.d/plugins"
              include = ["registry.terraform.io/binlab/jsonschema"]
            }
            direct {
              exclude = ["registry.terraform.io/binlab/jsonschema"]
            }
          }
          EOF
              
              # Initialize and plan
              # Remove lock file to avoid checksum issues with locally built provider
              rm -f .terraform.lock.hcl
              output=$(terraform init -no-color 2>&1)
              init_code=$?
              
              if [ $init_code -ne 0 ]; then
                echo "✗ FAILED: terraform init in ${example_dir}"
                echo "$output"
                failed=1
                cd - > /dev/null
                continue
              fi
              
              # Use terraform plan instead of validate
              # Examples with intentional validation errors are OK - only fail on actual errors
              output=$(terraform plan -no-color 2>&1)
              plan_code=$?
              
              # Check if it's a validation error (expected) or actual failure
              if [ $plan_code -eq 0 ]; then
                echo "✓ PASSED: ${example_dir}"
              elif echo "$output" | grep -q "VALIDATION ERRORS"; then
                # Validation errors are expected in demo examples
                echo "✓ PASSED: ${example_dir} (with expected validation errors)"
              else
                echo "✗ FAILED: terraform plan in ${example_dir}"
                echo "$output"
                failed=1
              fi
              
              cd - > /dev/null
              echo ""
            fi
          done

          exit $failed

  # verify CLI tool and pre-commit integration
  cli:
    name: Test CLI Tool
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.3"
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v4

      - name: Get dependencies
        run: |
          go mod download

      - name: Build CLI
        run: |
          go build -v -o jsonschema-validator ./cmd/jsonschema-validator

      - name: Test CLI basic functionality
        run: |
          ./jsonschema-validator --version
          ./jsonschema-validator --help

      - name: Test CLI validation (success case)
        run: |
          ./jsonschema-validator -s examples/pre-commit/schema.json examples/pre-commit/valid.json
          echo "✓ Valid document passed validation"

      - name: Test CLI validation (failure case)
        run: |
          if ./jsonschema-validator -s examples/pre-commit/schema.json examples/pre-commit/invalid.json 2>&1; then
            echo "ERROR: Expected validation to fail but it passed"
            exit 1
          else
            echo "✓ Invalid document correctly failed validation"
          fi

      - name: Test CLI with multiple documents
        run: |
          # Test with glob pattern
          ./jsonschema-validator -s examples/pre-commit/schema.json examples/pre-commit/*.json 2>&1 || true
          echo "✓ CLI handles multiple files"

      - name: Install CLI to GOPATH
        run: |
          go install ./cmd/jsonschema-validator

      - name: Test pre-commit hook (dry run)
        run: |
          # Verify the binary is in PATH
          which jsonschema-validator
          jsonschema-validator --version

          # Install pre-commit
          pip install pre-commit

          # Test with local config
          pre-commit run --config .pre-commit-config-test.yaml --hook-stage manual --files examples/pre-commit/valid.json
          echo "✓ Pre-commit hook passed for valid file"

          # Test that invalid file fails
          if pre-commit run --config .pre-commit-config-test.yaml --hook-stage manual --files examples/pre-commit/invalid.json 2>&1; then
            echo "ERROR: Expected pre-commit to fail but it passed"
            exit 1
          else
            echo "✓ Pre-commit hook correctly failed for invalid file"
          fi
