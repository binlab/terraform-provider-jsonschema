name: Require GPG Signed Commits
on: [pull_request]
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Import trusted maintainer keys
        if: vars.TRUSTED_GPG_KEYS != ''
        run: |
          echo "üì• Importing trusted maintainer GPG keys from repository variable"
          echo "${{ vars.TRUSTED_GPG_KEYS }}" | gpg --import
          echo "‚úÖ Trusted keys imported"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Import GPG keys from commits
        run: |
          # Extract all GPG key IDs from commits in the PR
          COMMITS=$(git rev-list ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "Commits to check: $COMMITS"

          for commit in $COMMITS; do
            # Get the GPG key ID from the commit
            KEY_ID=$(git show -s --format='%GK' "$commit")
            echo "Commit $commit has key ID: '$KEY_ID'"

            if [ -n "$KEY_ID" ] && [ "$KEY_ID" != "" ]; then
              # Check if key is already in keyring
              if gpg --list-keys "$KEY_ID" &>/dev/null; then
                echo "‚úÖ Key $KEY_ID is already in keyring"
              else
                # Try importing from GitHub user profile first
                COMMIT_AUTHOR_USERNAME=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                  "https://api.github.com/repos/${{ github.repository }}/commits/$commit" | jq -r '.author.login // .committer.login')

                imported_from_github=false
                if [ -n "$COMMIT_AUTHOR_USERNAME" ] && [ "$COMMIT_AUTHOR_USERNAME" != "null" ]; then
                  echo "üì• Attempting to import GPG key for GitHub user '$COMMIT_AUTHOR_USERNAME' from their profile"
                  if curl -sL "https://github.com/${COMMIT_AUTHOR_USERNAME}.gpg" | gpg --import; then
                    if gpg --list-keys "$KEY_ID" &>/dev/null; then
                      echo "‚úÖ Successfully imported key $KEY_ID from GitHub profile of '$COMMIT_AUTHOR_USERNAME'"
                      imported_from_github=true
                    else
                      echo "‚ö†Ô∏è  Key from GitHub profile did not match commit key ID $KEY_ID. Falling back to keyservers."
                    fi
                  else
                    echo "‚ö†Ô∏è  Could not import GPG key from GitHub profile for user '$COMMIT_AUTHOR_USERNAME'. Falling back to keyservers."
                  fi
                else
                  echo "‚ö†Ô∏è  Could not determine GitHub username for commit $commit. Falling back to keyservers."
                fi

                # If not imported from GitHub, try keyservers (original logic)
                if [ "$imported_from_github" = false ]; then
                  echo "üì• Attempting to import GPG key $KEY_ID from keyservers"
                  if gpg --keyserver hkps://keys.openpgp.org --recv-keys "$KEY_ID" 2>&1; then
                    echo "‚úÖ Successfully imported key $KEY_ID from keys.openpgp.org"
                  elif gpg --keyserver hkps://keyserver.ubuntu.com --recv-keys "$KEY_ID" 2>&1; then
                    echo "‚úÖ Successfully imported key $KEY_ID from keyserver.ubuntu.com"
                  elif gpg --keyserver hkps://pgp.mit.edu --recv-keys "$KEY_ID" 2>&1; then
                    echo "‚úÖ Successfully imported key $KEY_ID from pgp.mit.edu"
                  else
                    echo "‚ùå Could not import key $KEY_ID from any source."
                    exit 1
                  fi
                fi

                # Final verification that the key is now in the keyring
                if gpg --list-keys "$KEY_ID" &>/dev/null; then
                    echo "‚úÖ Key $KEY_ID is now in keyring"
                else
                    echo "‚ùå Key $KEY_ID is NOT in keyring after all import attempts"
                    exit 1
                fi
              fi
            else
              echo "‚ö†Ô∏è  No key ID found for commit $commit (unsigned commit)"
            fi
          done

      - name: Check commit signatures
        run: |
          # List commits in PR
          COMMITS=$(git rev-list ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          unsigned=0
          for commit in $COMMITS; do
            # Get signature verification details
            SIG_STATUS=$(git verify-commit "$commit" 2>&1) || true
            if git verify-commit "$commit" &>/dev/null; then
              echo "‚úÖ Commit $commit is GPG signed"
            else
              echo "‚ùå Commit $commit is not GPG signed or signature cannot be verified!"
              echo "   Signature details: $SIG_STATUS"
              unsigned=1
            fi
          done
          if [ "$unsigned" -eq 1 ]; then
            echo ""
            echo "ERROR: All commits in pull requests must be GPG signed"
            echo "Please ensure your commits are signed with 'git commit -S'"
            exit 1
          fi
          echo ""
          echo "‚úÖ All commits are GPG signed"
